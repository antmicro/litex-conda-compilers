name: build-packages
on: [push, pull_request]
env:
  ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}
  ANACONDA_USER: ${{ secrets.ANACONDA_USER }}
  NUM_OF_JOBS: 40
jobs:
  packages:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - {package: "lib/isl", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "lib/isl", os: "macos-latest", os-name: "osx"}
          - {package: "binutils", toolchain-arch: "or1k", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/nostdc", toolchain-arch: "or1k", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/newlib", toolchain-arch: "or1k", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/linux-musl", toolchain-arch: "or1k", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gdb", toolchain-arch: "or1k", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "binutils", toolchain-arch: "riscv32", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/nostdc", toolchain-arch: "riscv32", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/newlib", toolchain-arch: "riscv32", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/linux-musl", toolchain-arch: "riscv32", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gdb", toolchain-arch: "riscv32", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "binutils", toolchain-arch: "riscv32", os: "macos-latest", os-name: "osx"}
          - {package: "binutils", toolchain-arch: "riscv64", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/nostdc", toolchain-arch: "riscv64", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/newlib", toolchain-arch: "riscv64", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/linux-musl", toolchain-arch: "riscv64", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gdb", toolchain-arch: "riscv64", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "binutils", toolchain-arch: "riscv64", os: "macos-latest", os-name: "osx"}
          - {package: "binutils", toolchain-arch: "lm32", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/nostdc", toolchain-arch: "lm32", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/newlib", toolchain-arch: "lm32", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gdb", toolchain-arch: "lm32", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "binutils", toolchain-arch: "lm32", os: "macos-latest", os-name: "osx"}
          - {package: "binutils", toolchain-arch: "ppc64le", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/linux-musl", toolchain-arch: "ppc64le", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "binutils", toolchain-arch: "ppc64le", os: "macos-latest", os-name: "osx"}
          - {package: "binutils", toolchain-arch: "sh", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/nostdc", toolchain-arch: "sh", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/newlib", toolchain-arch: "sh", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gcc/linux-musl", toolchain-arch: "sh", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "gdb", toolchain-arch: "sh", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "binutils", toolchain-arch: "ppc64le", os: "macos-latest", os-name: "osx"}
          - {package: "toolchain/linux-musl", toolchain-arch: "or1k", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "toolchain/linux-musl", toolchain-arch: "riscv32", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "toolchain/linux-musl", toolchain-arch: "riscv64", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "toolchain/linux-musl", toolchain-arch: "sh", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "sdcc", os: "ubuntu-16.04", os-name: "linux"}
          - {package: "sdcc", os: "macos-latest", os-name: "osx"}
          - {package: "sdcc", os: "windows-latest", os-name: "windows", skip: "true"}
    defaults:
      run:
        shell: bash
    env:
      PACKAGE: ${{ matrix.package }}
      OS_NAME: ${{ matrix.os-name }}
      TOOLCHAIN_ARCH: ${{ matrix.toolchain-arch }}
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: 'true'
    - name: 'macos: install dependencies'
      if: matrix.os-name == 'osx'
      run: brew install coreutils boost
    - uses: antmicro/litex-conda-ci@move-to-ghactions
  master-package:
    runs-on: "ubuntu-16.04"
    env:
      OS_NAME: "linux"
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'true'
      - uses: actions/setup-python@v1
      - uses: BSFishy/pip-action@v1
        with:
          packages: urllib3
      - run: |
          bash .github/scripts/install.sh
          python .github/scripts/wait-for-statuses.py
